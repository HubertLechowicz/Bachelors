<html>
  <head>
    <title>Template</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">Template</a>
    </nav>
    <div class="content">
      <button onclick="async_task()">Run async task</button>
      <button onclick="increment()">Increment value</button>
      <h1>Value:</h1>
      <h3 id="val">0</h3>
      <div class="card card-progress"></div>
    </div>
  </body>
  <script>
    let x = 0;

    function get_task_status(task_id, el) {
      $.getJSON("status/" + task_id, function (data) {
        let message = "Status: " + data["status"] + "; ";
        if (data["state"] != "PENDING" && data["state"] != "PROGRESS") {
          if ("result" in data) {
            message = "Result: " + JSON.stringify(data["result"]) + "; ";
          } else {
            message = "State" + data["state"] + ";";
          }
          $(el).text(message);
        } else {
          $(el).text(message);
          setTimeout(function () {
            get_task_status(task_id, el);
          }, 1000);
        }
      });
    }

    function async_task() {
      $.ajax({
        url: "run",
        type: "POST",
        success: function (response) {
          $.each(response.task_ids, function (id, val) {
            let el = $("<p id=" + val + "></p>");
            get_task_status(val, el[0]);
            $(".card-progress").append(el);
          });
        },
      });
    }

    function increment() {
      x += 1;
      $("#val").text(x);
    }
  </script>
</html>
